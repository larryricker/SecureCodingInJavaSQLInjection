package northwind.vulnerability;

import java.io.IOException;
import java.io.InputStream;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.ResultSetMetaData;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.Properties;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

import org.springframework.boot.CommandLineRunner;

import org.springframework.context.annotation.Bean;

@SpringBootApplication
public class DemoApplication {
	private static final Logger LOGGER = LogManager.getLogger(DemoApplication.class.getClass());
	

	public static void main(String[] args) {
		SpringApplication.run(DemoApplication.class, args);
	}

	  @Bean
	  public CommandLineRunner vulnerabilityOrdersTest() {
		  return (args) -> {
			    // Initialization code like set up database etc....
				LOGGER.info("OrderSearch.init()");
				Connection con;
				try {
					Class.forName("org.postgresql.Driver");
				} catch (ClassNotFoundException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
				Properties prop = new Properties();
				String propertiesFilename = "application.properties";
				InputStream inputStream = getClass().getClassLoader().getResourceAsStream(propertiesFilename);
				if (inputStream != null) {
					try {
						prop.load(inputStream);
					} catch (IOException e) {
						// TODO Auto-generated catch block
						e.printStackTrace();
						LOGGER.error("property file: " + propertiesFilename + " not found!");
						return;
					}
				} else {
					LOGGER.error("property file: " + propertiesFilename + " not found!");
					return;
				}
				String url = prop.getProperty("spring.datasource.url");
				String user = prop.getProperty("spring.datasource.username");
				String password = prop.getProperty("spring.datasource.password");
				
				try {
//			        String customerID = "VINET";
// 			        String customerID = "VINET' OR 1=1 --";
//			        String customerID = "VINET' union select * from customers --";
//			        String customerID = "VINET' union select *, 1,2,3 from customers --";
// 			        String customerID = "VINET' union select *,'','','' from customers --";
// 			        String customerID = "VINET' union select 1, '', 2, * from customers --";
			        // select * from public.orders INNER JOIN customers ON (customers."CustomerID" = orders."CustomerID")
			        String message = "";
					con = DriverManager.getConnection(url,user,password);
					Statement st = con.createStatement();
		        	String sql = "select * from orders where \"CustomerID\" = '" + customerID + "'"; 
		        	LOGGER.info("\nsql:\n" + sql + "\n");
		            ResultSet rs = st.executeQuery(sql);

		            //Retrieving the ResultSetMetaData object
		            ResultSetMetaData rsmd = rs.getMetaData();
		            //getting the column type
		            int column_count = rsmd.getColumnCount();		            // Extract data from result set
		            while(rs.next()){
		               //Retrieve by column name
		            	for (int i = 1; i< column_count; i++) {
		            		message += rs.getString(i) + " ";
		            	}
		            	message += "\n";
		            }
	            	System.out.println(message);

		            rs.close();
		            con.close(); 

				} catch (SQLException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
		  };
	
	  }
	  
	  

//	  @Bean
//	  public CommandLineRunner vulnerabilitySuppliersTest() {
//		  return (args) -> {
//			    // Initialization code like set up database etc....
//				LOGGER.info("CustomerProfile.init()");
//				Connection con;
//				try {
//					Class.forName("org.postgresql.Driver");
//				} catch (ClassNotFoundException e) {
//					// TODO Auto-generated catch block
//					e.printStackTrace();
//				}
//				Properties prop = new Properties();
//				String propertiesFilename = "application.properties";
//				InputStream inputStream = getClass().getClassLoader().getResourceAsStream(propertiesFilename);
//				if (inputStream != null) {
//					try {
//						prop.load(inputStream);
//					} catch (IOException e) {
//						// TODO Auto-generated catch block
//						e.printStackTrace();
//						LOGGER.error("property file: " + propertiesFilename + " not found!");
//						return;
//					}
//				} else {
//					LOGGER.error("property file: " + propertiesFilename + " not found!");
//					return;
//				}
//				String url = prop.getProperty("spring.datasource.url");
//				String user = prop.getProperty("spring.datasource.username");
//				String password = prop.getProperty("spring.datasource.password");
//				
//				try {
//			        //  String supplierID = "1";
////			         String supplierID = "1 OR 1 = 1";
////			         String supplierID = "1 union select *, '' from customers --";
//			        String supplierID = "1 OR 1 = 1 union select 99, * from customers --";
//			        String message = "";
//					con = DriverManager.getConnection(url,user,password);
//					Statement st = con.createStatement();
//		        	String sql = "select * from suppliers where \"SupplierID\" = " + supplierID; 
//		        	LOGGER.info("\nsql:\n" + sql + "\n");
//		            ResultSet rs = st.executeQuery(sql);
//
//		            //Retrieving the ResultSetMetaData object
//		            ResultSetMetaData rsmd = rs.getMetaData();
//		            //getting the column type
//		            int column_count = rsmd.getColumnCount();		            // Extract data from result set
//		            while(rs.next()){
//		               //Retrieve by column name
//		            	for (int i = 1; i< column_count; i++) {
//		            		message += rs.getString(i) + " ";
//		            	}
//		            	message += "\n";
//		            }
//	            	System.out.println(message);
//
//		            rs.close();
//		            con.close(); 
//
//				} catch (SQLException e) {
//					// TODO Auto-generated catch block
//					e.printStackTrace();
//				}
//		  };
//	
//	  }

//	  @Bean
//	  public CommandLineRunner vulnerabilityCustomersTest() {
//		  return (args) -> {
//			    // Initialization code like set up database etc....
//				LOGGER.info("CustomerProfile.init()");
//				Connection con;
//				try {
//					Class.forName("org.postgresql.Driver");
//				} catch (ClassNotFoundException e) {
//					// TODO Auto-generated catch block
//					e.printStackTrace();
//				}
//				Properties prop = new Properties();
//				String propertiesFilename = "application.properties";
//				InputStream inputStream = getClass().getClassLoader().getResourceAsStream(propertiesFilename);
//				if (inputStream != null) {
//					try {
//						prop.load(inputStream);
//					} catch (IOException e) {
//						// TODO Auto-generated catch block
//						e.printStackTrace();
//						LOGGER.error("property file: " + propertiesFilename + " not found!");
//						return;
//					}
//				} else {
//					LOGGER.error("property file: " + propertiesFilename + " not found!");
//					return;
//				}
//				String url = prop.getProperty("spring.datasource.url");
//				String user = prop.getProperty("spring.datasource.username");
//				String password = prop.getProperty("spring.datasource.password");
//				
//				try {
// 			        //String customerID = "VINET";
//					String customerID = "VINET' OR 1 = '1";
//// 			        String customerID = "VINET' OR 1=1 --";
////			        String customerID = "VINET' union select * from suppliers --";
//			        // String customerID = "VINET' union select *, '' from suppliers --";
//			        String message = "";
//					con = DriverManager.getConnection(url,user,password);
//					Statement st = con.createStatement();
// 		        	String sql = "select * from customers where \"CustomerID\" = '" + customerID + "'"; 
//		        	LOGGER.info("\nsql:\n" + sql + "\n");
//		            ResultSet rs = st.executeQuery(sql);
//
//		            //Retrieving the ResultSetMetaData object
//		            ResultSetMetaData rsmd = rs.getMetaData();
//		            //getting the column type
//		            int column_count = rsmd.getColumnCount();		            // Extract data from result set
//		            while(rs.next()){
//		               //Retrieve by column name
//		            	for (int i = 1; i< column_count; i++) {
//		            		message += rs.getString(i) + " ";
//		            	}
//		            	message += "\n";
//		            }
//	            	System.out.println(message);
//
//		            rs.close();
//		            con.close(); 
//
//				} catch (SQLException e) {
//					// TODO Auto-generated catch block
//					e.printStackTrace();
//				}
//		  };
//	
//	  }


	  
}
